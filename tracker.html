<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>River Valley METRO ‚Äî Multi-Route Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
/* ----------------
  CSS Variables 
---------------- */
:root {
  --rv-blue: #3FA9F5;
  --rv-mid: #0b5fc1;
  --accent-black: #2c3e50;
  --muted: #7f8c8d;
  --bg-light: #f4f6f9;
  --card-bg: #ffffff;
  --shadow-light: rgba(11, 95, 193, 0.1);
  --shadow-medium: rgba(0, 0, 0, 0.05);
  --border-radius: 12px;
  --spacing: 16px;
  font-family: 'Poppins', sans-serif;
}

/* ----------------
  Base / Layout 
---------------- */
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
}

body {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  background: linear-gradient(180deg, var(--rv-blue) 0%, #d4e8ff 70%, var(--bg-light) 100%);
  color: var(--accent-black);
  min-height: 100vh;
  transition: background 0.5s, filter 0.5s;
}

body.service-off {
  background: linear-gradient(180deg, #b9b9b9 0%, #e0e0e0 100%);
  filter: grayscale(80%);
}

/* ----------------
  Header / Brand 
---------------- */
header {
  padding: var(--spacing) 0;
  display: flex;
  justify-content: center;
  align-items: center;
  width: min(100%, 1200px);
  box-sizing: border-box;
}

.brand {
  display: flex;
  flex-direction: column;
  align-items: center;
  line-height: 1;
}

.word-river {
  font-size: 1.5rem;
  color: var(--rv-mid);
  font-weight: 700;
}

.word-metro {
  font-size: 2.2rem;
  font-weight: 900;
  text-transform: uppercase;
  color: var(--accent-black);
}

/* ----------------
  Container / Main 
---------------- */
.container {
  margin: var(--spacing) auto 0;
  width: min(1024px, 94%);
  display: grid;
  grid-template-columns: 1fr 300px;
  gap: var(--spacing);
  padding: var(--spacing);
  border-radius: var(--border-radius);
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(8px);
  box-shadow: 0 10px 30px var(--shadow-medium);
}

@media (max-width: 920px) {
  .container {
    grid-template-columns: 1fr;
    width: 96%;
    padding: calc(var(--spacing) * 1.5) var(--spacing);
  }
}

.panel, .right {
  display: flex;
  flex-direction: column;
  gap: var(--spacing);
  align-items: stretch;
}

/* ----------------
  Controls 
---------------- */
.controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
  justify-content: flex-start;
}

select, button, .link-btn {
  font-size: 1rem;
  padding: 10px 15px;
  border-radius: 10px;
  border: 1px solid var(--rv-blue);
  background: var(--card-bg);
  color: var(--rv-mid);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 5px var(--shadow-light);
}

button:hover, .link-btn:hover {
  background: var(--rv-blue);
  color: white;
  box-shadow: 0 4px 10px var(--shadow-light);
  transform: translateY(-1px);
}

button:active, .link-btn:active {
  transform: translateY(1px);
  box-shadow: none;
}

select.route-select { min-width: 250px; }

/* ----------------
  Clock / Status 
---------------- */
.clock {
  font-size: 1.8rem;
  font-weight: 700;
  background: var(--card-bg);
  padding: var(--spacing);
  border-radius: var(--border-radius);
  text-align: left;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-left: 5px solid var(--rv-mid);
  box-shadow: 0 4px 15px var(--shadow-medium);
}

.clock .time {
  font-weight: 900;
  color: var(--accent-black);
}

.route-status-container {
  text-align: right;
}

.badge-running {
  background: #27ae60;
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 700;
  display: inline-block;
  margin-top: 4px;
}

.badge-off {
  background: #e74c3c;
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 700;
  display: inline-block;
  margin-top: 4px;
}

/* ----------------
  Stop / Countdown 
---------------- */
.next-stop-info {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: 12px;
  margin-top: 8px;
}

.stop {
  font-size: 1.15rem;
  background: linear-gradient(90deg, var(--rv-mid), var(--rv-blue));
  color: #fff;
  padding: var(--spacing) 18px;
  border-radius: var(--border-radius);
  width: 100%;
  text-align: left;
  font-weight: 700;
  box-shadow: 0 4px 10px rgba(11, 95, 193, 0.4);
}

.at-stop {
  background: #e67e22;
  color: #fff;
  font-weight: 800;
  box-shadow: 0 4px 10px rgba(230, 126, 34, 0.6);
}

.countdown-container {
  display: flex;
  gap: 10px;
  align-items: center;
  justify-content: space-between;
  padding: 0 8px;
}

.countdown {
  font-size: 1rem;
  background: #34495e;
  color: var(--rv-blue);
  padding: 8px 12px;
  border-radius: 8px;
  font-weight: 700;
  display: inline-block;
}

.note {
  font-size: 0.95rem;
  color: var(--muted);
}

/* ----------------
  Side Panel Cards 
---------------- */
.card {
  background: var(--card-bg);
  padding: var(--spacing);
  border-radius: var(--border-radius);
  box-shadow: 0 4px 12px var(--shadow-medium);
  border-top: 3px solid var(--rv-blue);
}

.card h3 {
  margin: 0 0 10px 0;
  font-size: 1.1rem;
  color: var(--rv-mid);
  border-bottom: 1px solid #ecf0f1;
  padding-bottom: 6px;
}

.contact-info p {
  margin: 6px 0;
  font-size: 0.95rem;
}

.card a {
  color: var(--rv-mid);
  text-decoration: none;
}

.link-btn {
  display: inline-block;
  margin-bottom: 5px;
}

/* ----------------
  Footer / Misc 
---------------- */
footer {
  font-size: 0.8rem;
  color: var(--muted);
  text-align: center;
  margin: 20px 0 60px;
  width: 100%;
}

.bus {
  position: fixed;
  bottom: 28px;
  left: -140px;
  font-size: 40px;
  animation: drive 12s linear infinite;
  color: var(--rv-mid);
}

@keyframes drive {
  0% { left: -160px; }
  48% { left: calc(100% + 60px); }
  50% { left: calc(100% + 60px); }
  51% { opacity: 0; }
  98% { left: -160px; opacity: 1; }
  100% { left: -160px; }
}

@media (max-width: 600px) {
  .clock { font-size: 1.5rem; }
  .bus { font-size: 32px; }
}

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}
  /* =========================
   9:16 PORTRAIT MODE
   ========================= */
@media (max-aspect-ratio: 9/16) {

  body {
    align-items: stretch;
    justify-content: flex-start;
  }

  header {
    width: 100%;
    padding-top: 12px;
    padding-bottom: 8px;
  }

  .container {
    width: 100%;
    max-width: 430px; /* true 9:16 phone width */
    margin: 0 auto;
    padding: 14px;
    grid-template-columns: 1fr; /* stack panels */
    gap: 14px;
    border-radius: 0;
  }

  .panel,
  .right {
    gap: 12px;
  }

  .controls {
    justify-content: space-between;
  }

  select.route-select {
    min-width: 100%;
  }

  .clock {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }

  .route-status-container {
    text-align: left;
    width: 100%;
  }

  .next-stop-info {
    gap: 10px;
  }

  .countdown-container {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }

  footer {
    margin-bottom: 90px;
  }

  .bus {
    bottom: 10px;
    font-size: 32px;
  }
}
</style>

</head>
<body>
<header>
  <div class="brand" aria-hidden="false">
    <div class="word-river" id="brandLine1">River Valley</div>
    <div class="word-metro" id="brandLine2">METRO</div>
  </div>
</header>

<main class="container" role="main" aria-labelledby="routeTitle">
  <section class="panel" aria-label="Primary panel">
    <div class="controls" role="region" aria-label="Controls">
      <label for="routeSelect" class="sr-only" id="routeSelectLabel">Select route</label>
      <select id="routeSelect" class="route-select" aria-labelledby="routeSelectLabel"></select>

      <label for="langSelect" class="sr-only" id="langSelectLabel">Language</label>
      <select id="langSelect" aria-labelledby="langSelectLabel">
        <option value="en">English</option>
        <option value="es">Espa√±ol</option>
      </select>

      <button id="readBtn">Trip Planner</button>

      <a id="transitSite" class="link-btn" href="https://www.rivervalleymetro.com/" target="_blank" rel="noopener">RVM.COM</a>
      
      <a id="facebookLink" class="link-btn" href="https://www.facebook.com/RiverValleyMetro/" target="_blank" rel="noopener">Facebook</a>
    </div>

    <div class="clock" id="routeTitle" aria-live="polite">
      <div>
        <div style="font-size:0.5em;color:var(--muted)" id="currentTimeLabel">Current Time</div>
        <div class="time" id="clockTime">--:--:--</div>
      </div>
      <div class="route-status-container">
        <div style="font-size:0.5em;color:var(--muted)" id="routeStatusLabel">Route Status</div>
        <div id="routeStatus" class="small badge-off">--</div>
      </div>
    </div>

    <div class="next-stop-info">
      <div class="stop" id="nextStop" aria-live="polite">Next Stop: --</div>
      <div class="countdown-container">
        <div class="countdown" id="countdown" aria-live="polite">Estimated Arrival Window: --</div>
        <div class="note" id="serviceNote">Service note: Delayed Weather</div>
      </div>
    </div>
  </section>

  <aside class="right" aria-label="Side panel">
    <div class="card">
      <h3 id="cardContactTitle">Contact Us üìû</h3>
      <div class="contact-info">
        <p id="cardContactText1">If your bus is late or has yet to arrive, call: <a href="tel:8159374287"><strong>815-937-4287</strong></a></p>
        <p id="cardContactText2">Questions about Benefit Access Passes - RVM Admin: <a href="tel:8159351403"><strong>815-935-1403</strong></a></p>
      </div>
      <p class="note small" style="margin-top:10px" id="cardContactNote">Go where you want to go with River Valley Metro.</p>
    </div>

    <div class="card">
      <h3 id="cardHolidayTitle">Holidays & Service üìÖ</h3>
      <p class="note small" id="cardHolidayText1">New Year‚Äôs Day, Memorial Day, 4th of July, Labor Day, Thanksgiving Day, and Christmas Day run <strong>Sunday</strong> service hours.</p>
      <p class="note small" id="holidayToday" style="margin-top:8px">‚Äî</p>
    </div>

    <div class="card">
      <h3 id="cardQuickTitle">Quick Links üîó</h3>
      <a id="customerSupport" class="link-btn" href="https://www.rivervalleymetro.com/customer-support/customer-complaints/" target="_blank" rel="noopener" role="button">
        Customer Support
      </a>
      <p class="note small" style="margin-top:10px" id="cardQuickNote">Times are estimates and may vary due to traffic, construction, and weather.</p>
    </div>
  </aside>
</main>

<footer id="footerNote">‚è±Ô∏è Times shown are estimates and may not reflect actual arrival times.</footer>
<div class="bus" aria-hidden="true">
  <img src="https://i.postimg.cc/5NnbyZ9r/1000024794-removebg-preview.png" alt="bus" width="40" height="40">
</div>

<script>
/* ----------------------
   JavaScript Logic - UPDATED with DWELL and TRANSLATION
   ---------------------- */
   
// --- TRANSLATION DATA ---
const translations = {
    en: {
        // Controls/Labels
        routeSelectLabel: 'Select route',
        langSelectLabel: 'Language',
        tripPlannerBtn: 'Trip Planner',
        currentTimeLabel: 'Current Time',
        routeStatusLabel: 'Route Status',
        nextStopPrefix: 'Next Stop: ',
        
        // Status/Notes
        routeStatusRunning: 'Running',
        routeStatusOffNow: 'Off Now',
        routeStatusOffToday: 'Off Today',
        serviceNoteNormal: 'Service note: Normal service',
        serviceNoteOffToday: 'Service note: Route does not operate today',
        noMoreRuns: 'No more scheduled runs for today',
        routeNotFound: 'Route not found',
        serviceOffNow: 'Service not running for this route right now',
        checkNextRun: 'Check next run time',
        checkNextDay: 'Check next day schedule',
        
        // Time/Stop
        scheduledStop: 'Scheduled Stop',
        scheduledDeparture: 'Scheduled Departure',
        scheduledArrival: 'Scheduled Arrival',
        busDwelling: 'BUS DWELLING at ',
        departingAt: ': Departing at ',
        departingNow: 'DEPARTING NOW! üì¢',
        dwellTime: 'DWELL TIME: Departing in ',
        inMin: ' min',
        inMinRange: ' ‚Äì ',
        arrDepIn: 'Arriving/Departing in: ',
        estimatedEta: 'Estimated ETA: ',
        estimatedEtaWindow: 'Estimated ETA Window: ',
        
        // Cards
        cardContactTitle: 'Contact Us üìû',
        cardContactText1: 'If your bus is late or has yet to arrive, call: ',
        cardContactText2: 'Questions about Benefit Access Passes - RVM Admin: ',
        cardContactNote: 'Go where you want to go with River Valley Metro.',
        cardHolidayTitle: 'Holidays & Service üìÖ',
        cardHolidayText1: 'New Year‚Äôs Day, Memorial Day, 4th of July, Labor Day, Thanksgiving Day, and Christmas Day run Sunday service hours.',
        cardQuickTitle: 'Quick Links üîó',
        cardQuickBtn: 'Customer Support',
        cardQuickNote: 'Times are estimates and may vary due to traffic, construction, and weather.',
        
        // Footer
        footerNote: '‚è±Ô∏è Times shown are estimates and may not reflect actual arrival times.',
        holidayTodayDefault: '‚Äî'
    },
    es: {
        // Controls/Labels
        routeSelectLabel: 'Seleccionar ruta',
        langSelectLabel: 'Idioma',
        tripPlannerBtn: 'Planificador de viajes',
        currentTimeLabel: 'Hora Actual',
        routeStatusLabel: 'Estado de la ruta',
        nextStopPrefix: 'Pr√≥xima Parada: ',
        
        // Status/Notes
        routeStatusRunning: 'En Marcha',
        routeStatusOffNow: 'Fuera de Servicio',
        routeStatusOffToday: 'Sin Servicio Hoy',
        serviceNoteNormal: 'Nota del servicio: Servicio normal',
        serviceNoteOffToday: 'Nota del servicio: La ruta no opera hoy',
        noMoreRuns: 'No m√°s viajes programados para hoy',
        routeNotFound: 'Ruta no encontrada',
        serviceOffNow: 'El servicio no est√° funcionando en este momento',
        checkNextRun: 'Consultar la pr√≥xima hora de salida',
        checkNextDay: 'Consultar el horario del pr√≥ximo d√≠a',
        
        // Time/Stop
        scheduledStop: 'Parada Programada',
        scheduledDeparture: 'Salida Programada',
        scheduledArrival: 'Llegada Programada',
        busDwelling: 'AUTOB√öS ESPERANDO en ',
        departingAt: ': Sale a las ',
        departingNow: 'SALIENDO AHORA! üì¢',
        dwellTime: 'TIEMPO DE ESPERA: Sale en ',
        inMin: ' min',
        inMinRange: ' ‚Äì ',
        arrDepIn: 'Llega/Sale en: ',
        estimatedEta: 'ETA Estimada: ',
        estimatedEtaWindow: 'Ventana de ETA Estimada: ',

        // Cards
        cardContactTitle: 'Cont√°ctenos üìû',
        cardContactText1: 'Si su autob√∫s llega tarde o a√∫n no ha llegado, llame al: ',
        cardContactText2: 'Preguntas sobre los pases de acceso a beneficios - Administraci√≥n de RVM: ',
        cardContactNote: 'Vaya a donde quiera ir con River Valley Metro.',
        cardHolidayTitle: 'D√≠as Festivos y Servicio üìÖ',
        cardHolidayText1: 'El D√≠a de A√±o Nuevo, el D√≠a de los Ca√≠dos, el 4 de Julio, el D√≠a del Trabajo, el D√≠a de Acci√≥n de Gracias y el D√≠a de Navidad operan con horario de servicio de domingo.',
        cardQuickTitle: 'Enlaces R√°pidos üîó',
        cardQuickBtn: 'Atenci√≥n al Cliente',
        cardQuickNote: 'Los horarios son estimaciones y pueden variar debido al tr√°fico, la construcci√≥n y el clima.',
        
        // Footer
        footerNote: '‚è±Ô∏è Los horarios son estimados y pueden no coincidir con la llegada real.',
        holidayTodayDefault: '‚Äî'
    }
};

// --- ROUTE AND SCHEDULE DATA (UNCHANGED) ---
const routes = {
  // RT1: Meadowview is first/last stop. Dwell at Kankakee Metro (:25/:30, :55/:00)
  "RT1":[{stop:"Family Dollar",times:[5,35]},{stop:"Azzarelli Apartments",times:[8,38]},{stop:"St. Mary's",times:[15,45]},{stop:"Walgreens Court St.",times:[19,49]},
    {stop:"Kankakee Metro Centre",times:[25, 30, 55, 0] } 
  ],
  // RT2: Dwell at Mall (:25/:30) and two cycles at Signature/Double Jack, Meijer is quick pass through.
  "RT2":[{stop:"Northfield Square Mall",times:[25, 30]},{stop:"Signature/Double Jack",times:[33, 19]},{stop:"Adventure Church",times:[38]},{stop:"Meijer (Southbound)",times:[45]},{stop:"Broadway Shelter",times:[51]},{stop:"Village Hall/Broadway",times:[58]},{stop:"Meijer (Northbound)",times:[7]},{stop:"Walmart",times:[14]},
    {stop:"Signature/Double Jack",times:[19]},
    {stop:"Northfield Square Mall",times:[25, 30]} 
  ],
  // RT3: Dwell at Kankakee Metro (:00/:05 - based on a 5-min dwell starting at the top of the hour) and Mall (:30/:35)
  "RT3":[
    {stop:"Kankakee Metro Centre",times:[0, 5, 49, 54]}, 
    {stop:"Bradley Library",times:[6]},{stop:"Christine and Uncle Leo",times:[13]},{stop:"Target",times:[20]},{stop:"Northfield Square Mall",times:[30, 35]}, 
    {stop:"Target",times:[37]},{stop:"Christine Dr. (behind Meijer)",times:[39]},{stop:"Village Square",times:[44]},
    {stop:"KCTC",times:[49, 54]} 
  ], 
  // RT4 NonPeak: Dwell at Kankakee Metro (:30/:35, :00/:05)
  "RT4NonPeak":[{stop:"East Court Village",times:[7]},{stop:"Frontage Road",times:[13]},{stop:"Spruce and Fairmont",times:[15]},{stop:"Family Dollar",times:[18]},
    {stop:"Kankakee Metro Centre",times:[30, 35, 0, 5]}, 
    {stop:"St. Mary's Hospital",times:[38]},{stop:"Riverside Medical Center",times:[40]},{stop:"Kankakee County Health Dept.",times:[45]},
    {stop:"Kankakee Metro Centre",times:[0, 5]} 
  ],
  // RT4 Peak: Dwell at Kankakee Metro (:30/:35, :00/:05). Times repeat every 30 mins
  "RT4Peak":[{stop:"East Court Village",times:[7,37]},{stop:"Frontage Road",times:[13,43]},{stop:"Spruce and Fairmont",times:[15,45]},{stop:"Family Dollar",times:[18,48]},
    {stop:"Kankakee Metro Centre",times:[0, 5, 30, 35]}, 
    {stop:"St. Mary's Hospital",times:[3,33]},{stop:"Riverside Medical Center",times:[10,40]},{stop:"Kankakee County Health Dept.",times:[15,45]},
    {stop:"Kankakee Metro Centre",times:[0, 5, 30, 35]} 
  ],
  // RT5: Dwell at Kankakee Metro (:00/:05, :30/:35)
  "RT5":[{stop:"Aroma Park Shelter",times:[30]},{stop:"Crestview",times:[35,16]},{stop:"Riverside East",times:[38]},{stop:"Maple and Eagle",times:[41]},{stop:"Eagle and Chicago",times:[46,6]},
    {stop:"Kankakee Metro Centre",times:[0, 5, 30, 35]}, 
    {stop:"Dollar General",times:[13]}
  ],
  // RT6: Dwell at Kankakee Metro (:30/:35)
  "RT6":[{stop:"Kankakee Metro Centre",times:[30, 35]}, 
    {stop:"Kankakee Estates",times:[36]},{stop:"K.C.C",times:[41]},{stop:"Del Monte",times:[46]},{stop:"Walmart",times:[58]},{stop:"Jerome Combs",times:[8]},{stop:"Schuyler and River",times:[18]}
  ],
  // RT7 NonPeak: Dwell at Kankakee Metro (:00/:05, :30/:35)
  "RT7NonPeak":[{stop:"Kankakee Metro Centre",times:[0, 5, 30, 35]}, 
    {stop:"Kankakee Estates",times:[6]},{stop:"Del Monte",times:[8]},{stop:"K.C.C",times:[16]},{stop:"Walmart Kankakee",times:[22,40]},{stop:"Jerome Combs",times:[29]},{stop:"Love's",times:[34]},{stop:"Harrison and Station",times:[48]}
  ],
  // RT7 Peak: Dwell at Kankakee Metro (:00/:05, :30/:35)
  "RT7Peak":[{stop:"Kankakee Metro Centre",times:[0, 5, 30, 35]}, 
    {stop:"Kankakee Estates",times:[6,36]},{stop:"K.C.C",times:[11]},{stop:"Walmart Kankakee",times:[15,42]},{stop:"Harrison and Station",times:[22,49]}
  ],
  // RT8: Dwell at Kankakee Metro (:00/:05, :30/:35)
  "RT8":[{stop:"Kankakee Metro Centre",times:[0, 5, 30, 35]}, 
    {stop:"Washington and Water",times:[3]},{stop:"Casey's on Jeffery",times:[8]},{stop:"Merchant and Curtis",times:[12]},{stop:"Kankakee High School",times:[15]},{stop:"Jewel on Washington",times:[19]},
    {stop:"Kankakee Metro Centre",times:[30, 35]}, 
    {stop:"Mulberry and Chicago",times:[33]},{stop:"Hobbie and Willow",times:[36]},{stop:"Broadway and Jefferson",times:[42]},{stop:"Brookmont and Harvard",times:[48]}
  ],
  // RT9: Dwell at Mall (:30/:35) and Manteno Metro Centre (:00/:05, :41/:46)
  "RT9":[{stop:"Manteno Metro Centre",times:[0, 5, 41, 46]}, 
    {stop:"ABC Supply",times:[7]},
    {stop:"Northfield Square Mall",times:[30, 35]}, 
    {stop:"Walmart",times:[33]},
    {stop:"Manteno Metro Centre",times:[41, 46]}, 
    {stop:"E. 2nd St.",times:[45]},{stop:"Veterans' Home",times:[52]}
  ],
  // RT10: Dwell at Bourbonnais Metro Centre (:13/:18, :42/:47) and Mall (:30/:35)
  "RT10":[{stop:"Brown Blvd.",times:[0]},{stop:"Casey's",times:[5,34]},{stop:"Riverside Campus",times:[7,36]},
    {stop:"Bourbonnais Metro Centre",times:[13, 18, 42, 47]}, 
    {stop:"Northfield Square Mall",times:[30, 35]}, 
    {stop:"W. Bethel Dr.",times:[50]},{stop:"Almar Parkway",times:[55]}
  ],
  // RT11: Dwell at Kankakee Metro (:00/:05, :30/:35) and Mall (:30/:35)
  "RT11":[{stop:"Kankakee Metro Centre",times:[0, 5, 30, 35]}, 
    {stop:"McDonald's 5th Ave.",times:[4,34]},{stop:"ONU",times:[11,42]},{stop:"Northfield Meadows",times:[18]},
    {stop:"Northfield Square Mall",times:[30, 35]}, 
    {stop:"Kroger",times:[36]},{stop:"Walgreens Kennedy Dr.",times:[48]}
  ],
  // RT12: Dwell at Kankakee Metro (:30/:35, :25/:30)
  "RT12":[{stop:"Kankakee Metro Centre",times:[30, 35]}, 
    {stop:"McDonald's 5th Av.",times:[34]},{stop:"Shine FM",times:[39]},{stop:"Meijer",times:[47]},{stop:"Kroger",times:[55]},{stop:"Brown Blvd.",times:[2]},{stop:"Heritage/Convent",times:[11]},{stop:"Perry Farm",times:[16]},{stop:"Walgreen's",times:[19]},
    {stop:"Kankakee Metro Centre",times:[25, 30]} 
  ],
  // RT14: Dwell at Kankakee Metro (:00/:05, :30/:35)
  "RT14":[{stop:"Kankakee Metro Centre",times:[0, 5, 30, 35]}, 
    {stop:"Mulberry/Chicago",times:[2]},{stop:"Fairmont/Court",times:[9]},{stop:"Eagle/Maple",times:[13]},{stop:"Harrison/Station",times:[20]},
    {stop:"Kankakee Metro Centre",times:[30, 35]}, 
    {stop:"Station/Schuyler",times:[33]},{stop:"Mercy Housing",times:[37]},{stop:"Merchant/Curtis",times:[41]},{stop:"Kankakee High School",times:[45]},{stop:"Kankakee Jewel",times:[49]}
  ]
};

const orderedRoutes =
['RT1','RT2','RT3','RT4NonPeak','RT4Peak','RT5','RT6','RT7NonPeak','RT7Peak','RT8','RT9','RT10','RT11','RT12','RT14'];

const select = document.getElementById('routeSelect');
const langSelect = document.getElementById('langSelect');
const readBtn = document.getElementById('readBtn');
const nextStopEl = document.getElementById('nextStop');
const countdownEl = document.getElementById('countdown');
const footerEl = document.getElementById('footerNote');
const routeStatusEl = document.getElementById('routeStatus');
const serviceNoteEl = document.getElementById('serviceNote');
const holidayTodayEl = document.getElementById('holidayToday');

let currentRouteKey = null;
let currentLang = 'en';

const routeSchedules = {
  weekday: {
    RT1:["05:05","21:25"], RT2:["05:30","21:25"], RT3:["05:00","21:25"], 
    RT4Peak:["07:00","18:00"], RT4NonPeak:["05:07","21:25"],
    RT5:["05:30","21:25"], RT6:["07:30","17:00"],
    RT7NonPeak:["05:00","07:00","17:00","21:25"], RT7Peak:["07:00","17:00"],
    RT8:["05:00","21:25"], RT9:["05:00","21:25"], RT10:["05:00","21:25"],
    RT11:["05:00","21:25"], RT12:["05:30","21:25"], RT14:["05:00","21:25"]
  },
  saturday: {
    RT1:["07:05","21:25"], RT2:["07:30","21:25"], RT3:["07:00","21:25"], 
    RT4Peak:null, RT4NonPeak:["07:07","21:25"],
    RT5:["07:30","21:25"], RT6:null,
    RT7NonPeak:["07:00","21:25"], RT7Peak:null,
    RT8:["07:00","21:25"], RT9:["07:00","21:25"], RT10:["07:00","21:25"],
    RT11:["07:00","21:25"], RT12:["07:30","21:25"], RT14:["07:00","21:25"]
  },
  sunday: {
    RT1:["08:05","15:47"], RT2:["08:30","15:55"], RT3:["08:00","15:55"], 
    RT4Peak:null, RT4NonPeak:["08:07","15:45"],
    RT5:["08:30","15:55"], RT6:null,
    RT7NonPeak:["08:00","15:34"], RT7Peak:null,
    RT8:["08:00","15:55"], RT9:["08:00","16:00"], RT10:["08:00","16:00"],
    RT11:["08:00","15:55"], RT12:["08:30","15:55"], RT14:["08:00","15:55"]
  }
};

function isMemorialDay(date) {
  const y = date.getFullYear();
  const lastDay = new Date(y, 4, 31);
  const dow = lastDay.getDay();
  const offset = (dow === 1) ? 0 : (dow === 0 ? 6 : dow - 1);
  const lastMonday = new Date(y, 4, 31 - offset);
  return date.getFullYear() === lastMonday.getFullYear() && date.getMonth() === lastMonday.getMonth() && date.getDate() === lastMonday.getDate();
}
function isLaborDay(date) {
  const y = date.getFullYear();
  for (let d=1; d<=7; d++){
    const dt = new Date(y,8,d);
    if (dt.getDay() === 1) return dt.getDate() === date.getDate() && dt.getMonth() === date.getMonth() && dt.getFullYear() === date.getFullYear();
  }
  return false;
}
function isThanksgiving(date) {
  const y = date.getFullYear();
  let thursCount = 0;
  for (let d=1; d<=30; d++){
    const dt = new Date(y,10,d);
    if (dt.getDay() === 4) { thursCount++; if (thursCount === 4) return dt.getDate() === date.getDate() && dt.getMonth() === date.getMonth() && dt.getFullYear() === date.getFullYear(); }
  }
  return false;
}
function isHolidayDate(date) {
  const m = date.getMonth();
  const d = date.getDate();
  if (m === 0 && d === 1) return true;
  if (m === 6 && d === 4) return true;
  if (m === 11 && d === 25) return true;
  if (isMemorialDay(date)) return true;
  if (isLaborDay(date)) return true;
  if (isThanksgiving(date)) return true;
  return false;
}
function getDayTypeForSchedule(date = new Date()) {
  if (isHolidayDate(date)) return 'sunday';
  const d = date.getDay();
  if (d === 0) return "sunday";
  if (d === 6) return "saturday";
  return "weekday";
}
function parseTimeToMinutes(t) {
  const [h,m] = t.split(':').map(Number);
  return h*60 + m;
}
function isRouteRunning(routeKey, date = new Date()) {
  const dayType = getDayTypeForSchedule(date);
  const sched = routeSchedules[dayType]?.[routeKey];
  if (!sched) return false;
  const now = date;
  const current = now.getHours()*60 + now.getMinutes();
  if (sched.length === 4) {
    const [s1,e1,s2,e2] = sched.map(parseTimeToMinutes);
    return (current >= s1 && current <= e1) || (current >= s2 && current <= e2);
  }
  const [start,end] = sched.map(parseTimeToMinutes);
  return current >= start && current <= end;
}

function populateRoutes() {
  const T = translations[currentLang];
  select.innerHTML = '';
  const dayType = getDayTypeForSchedule();
  orderedRoutes.forEach(k => {
    let label = (k === 'RT4NonPeak') ? 'RT4 NonPeak' :
                (k === 'RT4Peak') ? 'RT4 Peak' :
                (k === 'RT7NonPeak') ? 'RT7 NonPeak' :
                (k === 'RT7Peak') ? 'RT7 Peak' : k;
    const opt = document.createElement('option');
    opt.value = k;
    const runs = isRouteRunning(k);
    const sched = routeSchedules[getDayTypeForSchedule()]?.[k];
    if (!sched) {
      opt.disabled = true;
      opt.textContent = `${label} (${T.routeStatusOffToday})`;
      opt.title = T.routeStatusOffToday;
    } else {
      if (!runs) {
        opt.textContent = `${label} (${T.routeStatusOffNow})`;
        opt.title = T.routeStatusOffNow;
      } else {
        opt.textContent = label;
      }
    }
    select.appendChild(opt);
  });
}

function updateUIStrings() {
    const T = translations[currentLang];
    
    // Controls
    readBtn.textContent = T.tripPlannerBtn;
    document.getElementById('routeSelectLabel').textContent = T.routeSelectLabel;
    document.getElementById('langSelectLabel').textContent = T.langSelectLabel;
    
    // Clock/Status Labels
    document.getElementById('currentTimeLabel').textContent = T.currentTimeLabel;
    document.getElementById('routeStatusLabel').textContent = T.routeStatusLabel;

    // Card 1: Contact Us
    document.getElementById('cardContactTitle').innerHTML = T.cardContactTitle;
    document.getElementById('cardContactText1').innerHTML = T.cardContactText1 + '<a href="tel:8159374287"><strong>815-937-4287</strong></a>';
    document.getElementById('cardContactText2').innerHTML = T.cardContactText2 + '<a href="tel:8159351403"><strong>815-935-1403</strong></a>';
    document.getElementById('cardContactNote').textContent = T.cardContactNote;

    // Card 2: Holidays
    document.getElementById('cardHolidayTitle').innerHTML = T.cardHolidayTitle;
    document.getElementById('cardHolidayText1').innerHTML = T.cardHolidayText1; // Inner HTML is used to preserve <strong> tag
    
    // Card 3: Quick Links
    document.getElementById('cardQuickTitle').innerHTML = T.cardQuickTitle;
    document.getElementById('customerSupport').textContent = T.cardQuickBtn;
    document.getElementById('cardQuickNote').textContent = T.cardQuickNote;

    // Footer
    footerEl.textContent = T.footerNote;

    // Repopulate routes to translate the status labels in the dropdown
    populateRoutes(); 
    
    // Rerun updateRoute to translate dynamic messages
    updateRoute();
}

function updateClockDisplay() {
  const now = new Date();
  const h = ((now.getHours() + 11) % 12) + 1;
  const m = now.getMinutes().toString().padStart(2, '0');
  const s = now.getSeconds().toString().padStart(2, '0');
  const ampm = now.getHours() >= 12 ? "PM" : "AM";
  document.getElementById('clockTime').textContent = `${h}:${m}:${s} ${ampm}`;
}

function nextOccurrenceForMinute(base, minute, maxHours) {
  for (let h = 0; h <= maxHours; h++) {
    const cand = new Date(base.getTime());
    cand.setHours(base.getHours() + h, Number(minute), 0, 0);
    // Crucial check: only return the time if it's in the future
    if (cand.getTime() > base.getTime()) return cand; 
  }
  return null;
}

function updateRoute() {
  const T = translations[currentLang];
  const now = new Date();
  const selected = currentRouteKey;
  const ETA_VARIANCE = 2; 

  routeStatusEl.classList.remove('badge-running', 'badge-off');
  nextStopEl.classList.remove('at-stop');

  if (!selected || !routes[selected]) {
    nextStopEl.textContent = T.routeNotFound;
    countdownEl.textContent = '';
    routeStatusEl.textContent = '--';
    serviceNoteEl.textContent = 'Service note: --';
    return;
  }

  const isHoliday = isHolidayDate(now);
  const dayType = getDayTypeForSchedule(now);
  
  const dayTypeName = dayType.charAt(0).toUpperCase() + dayType.slice(1);
  if (currentLang === 'es') {
    holidayTodayEl.textContent = isHoliday 
        ? `Hoy es feriado ‚Äî utilizando horario de ${dayTypeName} (Domingo).` 
        : `Utilizando horario de ${dayTypeName}.`;
  } else {
    holidayTodayEl.textContent = isHoliday 
        ? `Today is a holiday ‚Äî using ${dayTypeName} (Sunday) schedule.` 
        : `Using ${dayTypeName} schedule.`;
  }

  const sched = routeSchedules[dayType]?.[selected];
  if (!sched) {
    nextStopEl.textContent = T.serviceOffToday;
    countdownEl.textContent = T.checkNextDay;
    routeStatusEl.textContent = T.routeStatusOffToday;
    routeStatusEl.classList.add('badge-off');
    document.body.classList.add('service-off');
    serviceNoteEl.textContent = T.serviceNoteOffToday;
    return;
  }

  if (!isRouteRunning(selected, now)) {
    nextStopEl.textContent = T.serviceOffNow;
    countdownEl.textContent = T.checkNextRun;
    routeStatusEl.textContent = T.routeStatusOffNow;
    routeStatusEl.classList.add('badge-off');
    document.body.classList.add('service-off');
    serviceNoteEl.textContent = `Service note: Route scheduled today from ${Array.isArray(sched) && sched.length===4 ? sched[0] + '-' + sched[1] + ' and ' + sched[2] + '-' + sched[3] : sched[0] + '-' + sched[1]}.`;
    return;
  } else {
    document.body.classList.remove('service-off');
    routeStatusEl.textContent = T.routeStatusRunning;
    routeStatusEl.classList.add('badge-running');
    serviceNoteEl.textContent = T.serviceNoteNormal;
  }

  const stops = routes[selected];
  const maxLookAheadHours = 8;
  let nextStop = null;
  let nextTime = null;
  let nextMinute = null;
  
  // 1. Find the absolute next scheduled time across all stops
  for (const stop of stops) {
    for (const min of stop.times) {
      const candidate = nextOccurrenceForMinute(now, min, maxLookAheadHours);
      if (!candidate) continue;
      if (!nextTime || candidate < nextTime) {
        nextStop = stop.stop;
        nextTime = candidate;
        nextMinute = min; 
      }
    }
  }
  
  if (!nextStop) {
    nextStopEl.textContent = T.noMoreRuns;
    countdownEl.textContent = '';
    return;
  }

  const formattedTime = nextTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  
  // 2. Dwell Time Logic Refinement
  let timeType = T.scheduledStop;
  const hubStops = ["Kankakee Metro Centre", "Northfield Square Mall", "Bourbonnais Metro Centre", "KCTC", "Manteno Metro Centre"];
  const diff_ms = nextTime - now;
  const diff_min = Math.floor(diff_ms / (1000 * 60));

  if (hubStops.includes(nextStop)) {
      
      const departureMinutes = [0, 5, 30, 35, 18, 47, 46, 54]; 
      
      if (departureMinutes.includes(nextMinute)) {
          timeType = T.scheduledDeparture;
          
          if (diff_min <= 5 && diff_min >= 0) {
              
              let arrivalTimeMin = nextMinute - 5; 
              let dwellArrivalCandidate = new Date(nextTime.getTime());

              if (nextMinute === 0) {
                arrivalTimeMin = 55;
                dwellArrivalCandidate.setHours(dwellArrivalCandidate.getHours() - 1);
              } else if (nextMinute === 54) {
                arrivalTimeMin = 49;
              } else if (nextMinute === 18) {
                arrivalTimeMin = 13;
              } else if (nextMinute === 47) {
                arrivalTimeMin = 42;
              } else if (nextMinute === 46) {
                arrivalTimeMin = 41;
              }

              dwellArrivalCandidate.setMinutes(arrivalTimeMin);
              
              if (now.getTime() >= dwellArrivalCandidate.getTime() && now.getTime() < nextTime.getTime()) {
                  nextStopEl.textContent = T.busDwelling + nextStop + T.departingAt + formattedTime;
                  const remaining_wait = Math.floor((nextTime - now) / (1000 * 60));
                  
                  let dw_low = Math.max(0, remaining_wait - 1);
                  let dw_high = Math.max(0, remaining_wait + 1);
                  
                  if (remaining_wait <= 1) {
                    countdownEl.textContent = T.departingNow;
                    nextStopEl.classList.add('at-stop');
                  } else {
                    countdownEl.textContent = T.dwellTime + dw_low + T.inMinRange + dw_high + T.inMin;
                    nextStopEl.classList.add('at-stop');
                  }
                  return; 
              }
          }
      } else {
        timeType = T.scheduledArrival;
      }
  }

  // 3. Standard ETA Window Calculation (if not currently dwelling)
  nextStopEl.textContent = T.nextStopPrefix + nextStop + ` (${timeType}) at ${formattedTime}`;
  
  let min_low = Math.max(0, diff_min - ETA_VARIANCE);
  let min_high = Math.max(0, diff_min + ETA_VARIANCE);
  
  let countdownText;
  if (min_low === min_high) {
    countdownText = T.estimatedEta + min_low + T.inMin;
  } else {
    countdownText = T.estimatedEtaWindow + min_low + T.inMinRange + min_high + T.inMin;
  }

  if (min_high <= 3) { 
    countdownEl.textContent = T.arrDepIn + min_low + T.inMinRange + min_high + T.inMin + ' ‚ö†Ô∏è';
    nextStopEl.classList.add('at-stop');
  } else {
    countdownEl.textContent = countdownText;
  }
}

// Event Listeners
select.addEventListener('change', () => {
  currentRouteKey = select.value;
  updateRoute();
});

langSelect.addEventListener('change', () => {
  currentLang = langSelect.value;
  updateUIStrings();
  // updateRoute is called inside updateUIStrings
});

readBtn.addEventListener('click', () => {
  const url = 'https://www.rivervalleymetro.com/customer-support/trip-planner/';
  window.open(url, '_blank');
});

// Initializer function
function initialize() {
  // Set currentRouteKey to the first non-disabled option or the first option
  populateRoutes();
  const opt = [...select.options].find(o => !o.disabled) || select.options[0];
  if (opt) {
    select.value = opt.value;
    currentRouteKey = opt.value;
  } else {
    currentRouteKey = orderedRoutes[0];
  }
  
  currentLang = langSelect.value || 'en';
  updateUIStrings();
  updateClockDisplay();
  
  // Update dropdown/labels every minute
  setInterval(() => {
    populateRoutes();
  }, 60 * 1000);
  
  // Main per-second update
  setInterval(() => {
    updateClockDisplay();
    updateRoute();
  }, 1000);
}

// Start sequence
(function start() {
  initialize();
})();
</script>
</body>
</html>
